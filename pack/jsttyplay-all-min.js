function fixHighCharCodes(a){var b=[];for(var c=0;c<a.length;c++)b.push(String.fromCharCode(a.charCodeAt(c)&255));return b.join("")}function DummyTerminal(a,b,c){function d(){return(new Date).getTime()/1e3}var e=this;e.startIfReady=function(){e.state.viewReady&&e.state.playReady&&e.go()},e.go=function(){e.state.time_diff=d()-e.state.tty_data[e.state.nextFrameIdx].time,e.advanceFrame()},e.advanceFrame=function(){var a=0;while(a<e.state.frameJumpMax&&e.state.nextFrameIdx<e.state.tty_data.length&&e.state.tty_data[e.state.nextFrameIdx].time+e.state.time_diff-d()<0)record=e.state.tty_data[e.state.nextFrameIdx++],e.vtview.parseData(record.data),a++;e.vtview.draw(),e.state.nextFrameIdx<e.state.tty_data.length&&(e.state.nextFrameTimeout=setTimeout(e.advanceFrame,e.state.tty_data[0].time+e.state.time_diff-d()*1e3+e.state.accurateTimeInterval))},e.opts=c||{},e.state={dump_url:b,nextFrameIdx:0,tty_data:null,frameJumpMax:20,time_diff:0,accurateTimeInterval:1e3/60,viewReady:!1,playReady:!1,playing:!1,initialState:null},e.run=function(){e.vtview=new VTCanvasView(a,{onReady:function(){e.state.viewReady=!0,e.startIfReady()},fontName:e.opts.font_name||"fixed-9x18"}),e.state.initialState={vtview:e.vtview.freeze(),nextFrameIdx:0}},e.get_data=function(a){get_binary_data_async(a,function(a,b){if(b)throw b;e.state.tty_data=TTYRecParse(a),e.state.playReady=!0,e.startIfReady()})},e.state.dump_url&&e.get_data(e.state.dump_url),e.player_interface={play_toggle:function(){e.state.nextFrameTimeout?(clearTimeout(e.state.nextFrameTimeout),e.state.nextFrameTimeout=null):e.go()}}}function r_uint64le(a,b){return r_uint32le(a,b+4)*65536*65536+r_uint32le(a,b)}function r_uint64be(a,b){return r_uint32be(a,b)*65536*65536+r_uint32be(a,b+4)}function r_uint32le(a,b){var c=a.charCodeAt(b+3)&255,d=a.charCodeAt(b+2)&255,e=a.charCodeAt(b+1)&255,f=a.charCodeAt(b)&255;return(c*256+d)*65536+(e*256+f)}function r_uint32be(a,b){var c=a.charCodeAt(b)&255,d=a.charCodeAt(b+1)&255,e=a.charCodeAt(b+2)&255,f=a.charCodeAt(b+3)&255;return(c*256+d)*65536+(e*256+f)}function r_uint16le(a,b){var c=a.charCodeAt(b+1)&255,d=a.charCodeAt(b)&255;return c*256+d}function r_uint16be(a,b){var c=a.charCodeAt(b)&255,d=a.charCodeAt(b+1)&255;return c*256+d}function r_uint8(a,b){return a.charCodeAt(b)&255}function get_binary_data_async(a,b){var c=new XMLHttpRequest;c.open("GET",a,!0),c.overrideMimeType("text/plain; charset=x-user-defined"),c.onreadystatechange=function(){c.readyState==4&&(c.status!=200?b(null,c.statusText):b(c.responseText,null))},c.send(null)}function get_binary_data_sync(a){var b=new XMLHttpRequest;b.open("GET",a,!1),b.overrideMimeType("text/plain; charset=x-user-defined"),b.send(null);if(b.status!=200){alert("couldn't fetch binary data from "+a+", code "+b.status);return""}return b.responseText}var VTCanvasView=function(){var a=["0,0,0","192,0,0","0,192,0","192,192,0","0,0,192","192,0,192","0,192,192","192,192,192"],b=["0,0,0","255,0,0","0,255,0","255,255,0","0,0,255","255,0,255","0,255,255","255,255,255"],c=function(a){var b=[];for(var c in a)b.push(a[c]);return b};return function(d,e){var f=this;if(!(d instanceof HTMLCanvasElement))throw"First argument to VTCanvasView constructor must be an HTMLCanvasElement (was "+d+")";f.lowColors=c(a),f.hiColors=c(b),f.fontName="qemu-vgafont",f.onReady=[],f.autoResize=!0,f.cv=d,e.fontName&&(f.fontName=e.fontName),e.autoResize&&(f.autoResize=e.autoResize),e.onReady&&f.onReady.push(e.onReady),f.cursor={cur:{x:0,y:0},drawn:{x:0,y:0}},f.emu=new VTEmulator({change:function(a,b,c){f.makeSpanDirty(a,b,c)},cursor:function(a,b){a>=f.emu.width&&(a=f.emu.width-1),f.cursor.cur.x=a,f.cursor.cur.y=b},special:function(a){if(a.thaw){for(var b=0;b<f.emu.height;b++)f.makeSpanDirty(b,0,f.emu.width-1);f.cursor.cur.x=f.emu.cursor.x,f.cursor.cur.y=f.emu.cursor.y}}}),f.parser=new VTParser(function(){f.emu.handleEvent(Array.prototype.slice.call(arguments))}),f.dirtySpans=[];for(var g=0;g<f.emu.height;g++)f.dirtySpans[g]={min:0,max:f.emu.width-1};VTFont.open(f.fontName,function(a){f.font=a,f.readyCheck()})}}();VTCanvasView.prototype.freeze=function(){return{emulator:this.emu.freeze(),parser:this.parser.freeze()}},VTCanvasView.prototype.thaw=function(a){this.emu.thaw(a.emulator),this.parser.thaw(a.parser)},VTCanvasView.prototype.parseData=function(a){this.parser.parse(a)},VTCanvasView.prototype.makeSpanDirty=function(a,b,c){if(a>=this.emu.height||b<0||c>=this.emu.width)throw"argh";var d=this.dirtySpans[a];d.min>b&&(d.min=b),d.max<c&&(d.max=c)},VTCanvasView.prototype.dirtyMovedCursor=function(){var a=this.cursor;if(a.cur.x!=a.drawn.x||a.cur.y!=a.drawn.y)this.makeSpanDirty(a.cur.y,a.cur.x,a.cur.x),this.makeSpanDirty(a.drawn.y,a.drawn.x,a.drawn.x),a.drawn.x=a.cur.x,a.drawn.y=a.cur.y},VTCanvasView.prototype.draw=function(){this.dirtyMovedCursor();var a=this.cv.getContext("2d"),b=this.font.charWidth,c=this.font.charHeight;for(var d=0;d<this.emu.height;d++){var e=this.dirtySpans[d];for(var f=e.min;f<=e.max;f++){var g=d*this.emu.width+f,h=this.lowColors[this.emu.scr.c.bcolor[g]],i=(this.emu.scr.c.lowintensity[g]?this.lowColors:this.hiColors)[this.emu.scr.c.fcolor[g]],j=this.emu.scr.c.text[g];if(this.cursor.cur.x==f&&this.cursor.cur.y==d){var k=i,l=h;i=l,h=k}this.font.drawChar(a,j,f*b,d*c,i,h)}e.min=this.emu.width-1,e.max=0}},VTCanvasView.prototype.readyCheck=function(){this.font&&this.ready()},VTCanvasView.prototype.ready=function(){this.autoResize&&(this.cv.setAttribute("width",this.emu.width*this.font.charWidth),this.cv.setAttribute("height",this.emu.height*this.font.charHeight)),this.onReady.forEach(function(a){a()}),this.draw()};var VTEmulator=function(){function e(a,b){b.splice(0,b.length);for(var c in a){b[c]={};for(var d in a[c])b[c][d]=a[c][d]}}function d(a,b){b.splice(0,b.length);for(var c in a)b.push(a[c])}function c(a,b){for(var c in b)delete b[c];for(var c in a)b[c]=a[c]}function b(a){return String.fromCharCode(parseInt(a,16))}function a(a){return a?"T":"F"}var f=function(a){a.change&&(this.changeCallback=a.change),a.special&&(this.specialCallback=a.special),a.output&&(this.outputCallback=a.output),a.cursor&&(this.cursorCallback=a.cursor),this.width=a.width||80,this.height=a.height||24,this.initialize()};f.prototype={initialize:function(){this.scr={},this.scralt={},this.scr.lineAttr=[],this.scralt.lineAttr=[];for(var a=0;a<this.height;a++)this.scr.lineAttr.push({width:"normal",height:"normal"}),this.scralt.lineAttr.push({width:"normal",height:"normal"});this.scr.c={},this.scr.c.text=[],this.scr.c.bold=[],this.scr.c.underline=[],this.scr.c.lowintensity=[],this.scr.c.blink=[],this.scr.c.fcolor=[],this.scr.c.bcolor=[],this.scralt.c={},this.scralt.c.text=[],this.scralt.c.bold=[],this.scralt.c.underline=[],this.scralt.c.lowintensity=[],this.scralt.c.blink=[],this.scralt.c.fcolor=[],this.scralt.c.bcolor=[];for(var a=0;a<this.width*this.height;a++)this.scr.c.text.push(" "),this.scr.c.bold.push(!1),this.scr.c.underline.push(!1),this.scr.c.lowintensity.push(!0),this.scr.c.blink.push(!1),this.scr.c.fcolor.push(7),this.scr.c.bcolor.push(0),this.scralt.c.text.push(" "),this.scralt.c.bold.push(!1),this.scralt.c.underline.push(!1),this.scralt.c.lowintensity.push(!0),this.scralt.c.blink.push(!1),this.scralt.c.fcolor.push(7),this.scralt.c.bcolor.push(0);this.mode={},this.mode.cursorKeyANSI=!0,this.mode.scroll="jump",this.mode.reverseScreen=!1,this.mode.originMode="screen",this.mode.autoWrap=!0,this.mode.autoRepeat=!0,this.mode.mouseTrackingDown=!1,this.mode.mouseTrackingUp=!1,this.mode.currentScreen=1,this.mode.keyboardLocked=!1,this.mode.insert=!1,this.mode.localEcho=!0,this.mode.newLineMode="cr",this.cursor={},this.cursor.x=0,this.cursor.y=0,this.cursor.bold=!1,this.cursor.underline=!1,this.cursor.lowintensity=!0,this.cursor.blink=!1,this.cursor.reversed=!1,this.cursor.invisible=!1,this.cursor.fcolor=7,this.cursor.bcolor=0,this.cursorStack=[],this.margins={},this.margins.top=0,this.margins.bottom=this.height-1,this.tabs={};for(var b=0;b<this.width;b++)this.tabs[b]=b%8==0;this.windowTitle="",this.iconTitle="",this.charsets={},this.charsets.g0="us",this.charsets.g1="line",this.charsets.active="g0"},freeze:function(){var a={scr:{lineAttr:[]},scralt:{lineAttr:[]}};e(this.scr.lineAttr,a.scr.lineAttr),e(this.scralt.lineAttr,a.scralt.lineAttr),a.scr.c={text:[],bold:[],underline:[],lowintensity:[],blink:[],fcolor:[],bcolor:[]},d(this.scr.c.text,a.scr.c.text),d(this.scr.c.bold,a.scr.c.bold),d(this.scr.c.underline,a.scr.c.underline),d(this.scr.c.lowintensity,a.scr.c.lowintensity),d(this.scr.c.blink,a.scr.c.blink),d(this.scr.c.fcolor,a.scr.c.fcolor),d(this.scr.c.bcolor,a.scr.c.bcolor),a.scralt.c={text:[],bold:[],underline:[],lowintensity:[],blink:[],fcolor:[],bcolor:[]},d(this.scralt.c.text,a.scralt.c.text),d(this.scralt.c.bold,a.scralt.c.bold),d(this.scralt.c.underline,a.scralt.c.underline),d(this.scralt.c.lowintensity,a.scralt.c.lowintensity),d(this.scralt.c.blink,a.scralt.c.blink),d(this.scralt.c.fcolor,a.scralt.c.fcolor),d(this.scralt.c.bcolor,a.scralt.c.bcolor),a.mode={},c(this.mode,a.mode),a.cursor={},c(this.cursor,a.cursor),a.cursorStack=[],e(this.cursorStack,a.cursorStack),a.margins={},c(this.margins,a.margins),a.tabs={},c(this.tabs,a.tabs),a.windowTitle=this.windowTitle,a.iconTitle=this.iconTitle,a.charsets={},c(this.charsets,a.charsets);return a},thaw:function(a){e(a.scr.lineAttr,this.scr.lineAttr),e(a.scralt.lineAttr,this.scralt.lineAttr),d(a.scr.c.text,this.scr.c.text),d(a.scr.c.bold,this.scr.c.bold),d(a.scr.c.underline,this.scr.c.underline),d(a.scr.c.lowintensity,this.scr.c.lowintensity),d(a.scr.c.blink,this.scr.c.blink),d(a.scr.c.fcolor,this.scr.c.fcolor),d(a.scr.c.bcolor,this.scr.c.bcolor),d(a.scralt.c.text,this.scralt.c.text),d(a.scralt.c.bold,this.scralt.c.bold),d(a.scralt.c.underline,this.scralt.c.underline),d(a.scralt.c.lowintensity,this.scralt.c.lowintensity),d(a.scralt.c.blink,this.scralt.c.blink),d(a.scralt.c.fcolor,this.scralt.c.fcolor),d(a.scralt.c.bcolor,this.scralt.c.bcolor),c(a.mode,this.mode),c(a.cursor,this.cursor),e(a.cursorStack,this.cursorStack),c(a.margins,this.margins),c(a.tabs,this.tabs),this.windowTitle=a.windowTitle,this.iconTitle=a.iconTitle,c(a.charsets,this.charsets),this.postSpecial({thaw:"thaw"})},charmap:{us:{},uk:{"#":b("A3")},line:{_:" ","`":b("2666"),a:b("2591"),b:b("2409"),c:b("240C"),d:b("240D"),e:b("240A"),f:b("B0"),g:b("B1"),h:b("2424"),i:b("240B"),j:b("2518"),k:b("2510"),l:b("250C"),m:b("2514"),n:b("253C"),q:b("2500"),t:b("2524"),u:b("251C"),v:b("2534"),w:b("252C"),x:b("2502"),y:b("2264"),z:b("2265"),"{":b("3C0"),"|":b("2260"),"}":b("A3"),"~":b("B7")}},postChange:function(a,b,c){this.changeCallback&&this.changeCallback(a,b,c)},postSpecial:function(a){this.specialCallback&&this.specialCallback(a)},postCursor:function(){this.cursorCallback&&this.cursorCallback(this.cursor.x,this.cursor.y)},ev_setWindowTitle:function(a){this.windowTitle=a,this.postSpecial({title:a})},ev_setIconTitle:function(a){this.iconTitle=a,this.postSpecial({title:a})},ev_setWindowIconTitle:function(a){this.ev_setWindowTitle(a),this.ev_setIconTitle(a)},ev_resetMargins:function(){this.ev_setMargins(1,this.height)},ev_setMargins:function(a,b){a-=1,b-=1,a+1>=b&&(a=b-1),a<0&&(a=0),a>this.height-2&&(a=this.height-2),b<1&&(b=1),b>this.height-1&&(b=this.height-1);if(a+1>=b)throw"numbers do not obey the laws of arithmetic in setMargins";this.margins.top=a,this.margins.bottom=b,this.ev_goto("home")},ev_cursorStack:function(a){if(a=="push")this.cursorStack.push({x:this.cursor.x,y:this.cursor.y,bold:this.cursor.bold,underline:this.cursor.underline,lowintensity:this.cursor.lowintensity,blink:this.cursor.blink,reversed:this.cursor.reversed,invisible:this.cursor.invisible,fcolor:this.cursor.fcolor,bcolor:this.cursor.bcolor});else if(a=="pop")this.cursorStack.length>0&&(this.cursor=this.cursorStack.pop()),this.postCursor();else throw"Can't do cursorStack action "+a},ev_setAttribute:function(a){if(a==0)this.cursor.bold=!1,this.cursor.underline=!1,this.cursor.lowintensity=!0,this.cursor.blink=!1,this.cursor.reversed=!1,this.cursor.invisible=!1,this.cursor.fcolor=7,this.cursor.bcolor=0;else if(a==1||a==21)this.cursor.bold=a==1;else if(a==2||a==22)this.cursor.lowintensity=a==2;else if(a==4||a==24)this.cursor.underline=a==4;else if(a==5||a==25)this.cursor.blink=a==5;else if(a==7||a==27){if(!(this.cursor.reversed&&a==7||!this.cursor.reversed&&a==27)){var b=this.cursor.fcolor,c=this.cursor.bcolor;this.cursor.fcolor=c,this.cursor.bcolor=b,this.cursor.reversed=a==7}}else a==8||a==28?this.cursor.invisible=a==8:a>=30&&a<40?this.cursor.fcolor=a-30:a>=40&&a<=49?this.cursor.bcolor=a-40:console.log("Warning: ignoring setAttribute("+a+")")},ev_normalString:function(a){for(var b=0;b<a.length;b++)this.ev_normalChar(a[b])},ev_normalChar:function(a){this.charsets.active&&this.charsets[this.charsets.active]&&this.charmap[this.charsets[this.charsets.active]]&&this.charmap[this.charsets[this.charsets.active]][a]&&(a=this.charmap[this.charsets[this.charsets.active]][a]);if(this.cursor.x==this.width)if(this.mode.autoWrap){var b=this.mode.originMode=="screen"?this.height:this.margins.bottom+1;this.cursor.x=0,this.cursor.y++,this.cursor.y>=b&&(this.scroll(1),this.cursor.y=b-1)}else this.cursor.x--;if(this.mode.insert){var c=this.cursor.x+this.cursor.y*this.width,d=(this.cursor.y+1)*this.width;this.scr.c.text.splice(c,0,a),this.scr.c.text.splice(d,1),this.scr.c.bold.splice(c,0,this.cursor.bold),this.scr.c.bold.splice(d,1),this.scr.c.underline.splice(c,0,this.cursor.underline),this.scr.c.underline.splice(d,1),this.scr.c.lowintensity.splice(c,0,this.cursor.lowintensity),this.scr.c.lowintensity.splice(d,1),this.scr.c.blink.splice(c,0,this.cursor.blink),this.scr.c.blink.splice(d,1),this.scr.c.fcolor.splice(c,0,this.cursor.fcolor),this.scr.c.fcolor.splice(d,1),this.scr.c.bcolor.splice(c,0,this.cursor.bcolor),this.scr.c.bcolor.splice(d,1),this.postChange(this.cursor.y,this.cursor.x,this.width-1)}else this.putChar("set",this.cursor.x,this.cursor.y,a,this.cursor.bold,this.cursor.underline,this.cursor.lowintensity,this.cursor.blink,this.cursor.fcolor,this.cursor.bcolor),this.postChange(this.cursor.y,this.cursor.x,this.cursor.x);this.cursor.x++,this.postCursor()},ev_specialChar:function(a){switch(a){case"carriageReturn":this.cursor.x=0,this.postCursor();break;case"backspace":this.cursor.x--,this.cursor.x<0&&(this.cursor.x=0),this.postCursor();break;case"lineFeed":case"formFeed":case"verticalTab":this.cursor.y++,this.cursor.y==this.margins.bottom+1&&(this.scroll(1),this.cursor.y=this.margins.bottom),this.cursor.y>=this.height&&(this.cursor.y=this.height-1),this.mode.newLineMode=="crlf"&&(this.cursor.x=0),this.postCursor();break;case"horizontalTab":do this.cursor.x++;while(this.cursor.x<this.width&&!this.tabs[this.cursor.x]);this.postCursor();break;case"bell":this.postSpecial({bell:"bell"});break;default:console.log("Warning: skipping specialChar event for key "+a)}},ev_arrow:function(a,b){var c=this.mode.originMode=="screen"?0:this.margins.top,d=this.mode.originMode=="screen"?this.height:this.margins.bottom+1;switch(a){case"up":this.cursor.y-=b,this.cursor.y<c&&(this.cursor.y=c),this.postCursor();break;case"down":this.cursor.y+=b,this.cursor.y>=d&&(this.cursor.y=d-1),this.postCursor();break;case"left":this.cursor.x-=b,this.cursor.x<0&&(this.cursor.x=0),this.postCursor();break;case"right":this.cursor.x+=b,this.cursor.x>=this.width&&(this.cursor.x=this.width-1),this.postCursor();break;default:throw"Can't handle arrow event with direction "+a}},ev_deleteChars:function(a){var b=this.cursor.x+this.cursor.y*this.width,c=(this.cursor.y+1)*this.width-2;for(var d=0;d<a;d++)this.scr.c.text.splice(b,1),this.scr.c.text.splice(c,0," "),this.scr.c.bold.splice(b,1),this.scr.c.bold.splice(c,0,!1),this.scr.c.underline.splice(b,1),this.scr.c.underline.splice(c,0,!1),this.scr.c.lowintensity.splice(b,1),this.scr.c.lowintensity.splice(c,0,!1),this.scr.c.blink.splice(b,1),this.scr.c.blink.splice(c,0,!1),this.scr.c.fcolor.splice(b,1),this.scr.c.fcolor.splice(c,0,7),this.scr.c.bcolor.splice(b,1),this.scr.c.bcolor.splice(c,0,0);this.postChange(this.cursor.y,this.cursor.x,this.width-1)},ev_deleteLines:function(a){if(!(this.cursor.y>this.margins.bottom)){if(this.cursor.y<this.margins.top)return;for(var b=0;b<a;b++){for(var c=this.cursor.y;c<this.margins.bottom;c++)for(var d=0;d<this.width;d++){var e=d+(c+1)*this.width;this.putChar("set",d,c,this.scr.c.text[e],this.scr.c.bold[e],this.scr.c.underline[e],this.scr.c.lowintensity[e],this.scr.c.blink[e],this.scr.c.fcolor[e],this.scr.c.bcolor[e])}for(var d=0;d<this.width;d++)this.scr.c.text[this.margins.bottom*this.width+d]=" ";this.scr.lineAttr.splice(this.margins.bottom,0,{width:this.scr.lineAttr[this.margins.bottom-1].width,height:this.scr.lineAttr[this.margins.bottom-1].height}),this.scr.lineAttr.splice(this.cursor.y,1)}for(var c=this.cursor.y;c<=this.margins.bottom;c++)this.postChange(c,0,this.width-1)}},ev_insertLines:function(a){if(!(this.cursor.y>this.margins.bottom)){if(this.cursor.y<this.margins.top)return;for(var b=0;b<a;b++){for(var c=this.margins.bottom;c>this.cursor.y;c--)for(var d=0;d<this.width;d++){var e=d+(c-1)*this.width;this.putChar("set",d,c,this.scr.c.text[e],this.scr.c.bold[e],this.scr.c.underline[e],this.scr.c.lowintensity[e],this.scr.c.blink[e],this.scr.c.fcolor[e],this.scr.c.bcolor[e])}for(var d=0;d<this.width;d++)this.putChar("set",d,this.cursor.y," ",!1,!1,!0,!1,7,0);this.scr.lineAttr.splice(this.margins.bottom,1),this.scr.lineAttr.splice(this.cursor.y,0,{width:"normal",height:"normal"})}for(var c=this.cursor.y;c<=this.margins.bottom;c++)this.postChange(c,0,this.width-1)}},ev_index:function(a){switch(a){case"down":this.cursor.y==this.margins.bottom?this.scroll(1):(this.cursor.y++,this.postCursor());break;case"up":this.cursor.y==this.margins.top?this.scroll(-1):(this.cursor.y--,this.postCursor());break;case"nextLine":this.ev_index("down"),this.cursor.x=0,this.postCursor();break;default:throw"Can't index with method "+a}},ev_originMode:function(a){this.mode.originMode=a,this.ev_goto("home")},ev_mode:function(a,b){switch(a){case"insert":case"cursorKeyANSI":case"keypad":case"mouseTrackingUp":case"mouseTrackingDown":case"autoWrap":case"scroll":this.mode[a]=b;var c={};c[a]=b,this.postSpecial({mode:c});break;case"currentScreen":var d=this.mode.currentScreen;if(d!=b){var e=this.scralt,f=this.scr;this.scr=e,this.newscralt=f,this.mode.currentScreen=b}for(var g=0;g<this.height;g++)this.postChange(g,0,this.width-1);break;default:console.log("Warning: can't handle mode change '"+a+"' to '"+b+"'")}},ev_eraseInLine:function(a){switch(a){case"toEnd":for(var b=this.cursor.x;b<this.width;b++)this.putChar("set",b,this.cursor.y," ",!1,!1,!0,!1,7,0);this.postChange(this.cursor.y,this.cursor.x,this.width-1);break;case"toStart":for(var b=this.cursor.x;b>=0;b--)this.putChar("set",b,this.cursor.y," ",!1,!1,!0,!1,7,0);this.postChange(this.cursor.y,0,this.cursor.x);break;case"whole":for(var b=0;b<this.width;b++)this.putChar("set",b,this.cursor.y," ",!1,!1,!0,!1,7,0);this.postChange(this.cursor.y,0,this.width-1);break;default:throw"Can't eraseInLine with method '"+a+"'"}},ev_eraseInDisplay:function(a){switch(a){case"toEnd":this.ev_eraseInLine("toEnd");for(var b=this.cursor.y+1;b<this.height;b++){for(var c=0;c<this.width;c++)this.putChar("set",c,b," ",!1,!1,!0,!1,7,0);this.scr.lineAttr.splice(b,1,{width:"normal",height:"normal"})}for(var b=this.cursor.y+1;b<this.height;b++)this.postChange(b,0,this.width-1);break;case"toStart":this.ev_eraseInLine("toStart");for(var b=this.cursor.y-1;b>=0;b--){for(var c=0;c<this.width;c++)this.putChar("set",c,b," ",!1,!1,!0,!1,7,0);this.scr.lineAttr.splice(b,1,{width:"normal",height:"normal"})}for(var b=this.cursor.y-1;b>=0;b--)this.postChange(b,0,this.width-1);break;case"whole":for(var b=0;b<this.height;b++){for(var c=0;c<this.width;c++)this.putChar("set",c,b," ",!1,!1,!0,!1,7,0);this.scr.lineAttr.splice(b,1,{width:"normal",height:"normal"})}for(var b=0;b<this.height;b++)this.postChange(b,0,this.width-1);break;default:throw"Can't eraseInDisplay with method '"+a+"'"}},ev_goto:function(a){var b,c;a=="home"?b=c=0:(b=a[0]-1,c=a[1]-1),b<0&&(b=0),b>this.width&&(b=this.width),this.mode.originMode=="screen"?(c<0&&(c=0),c>=this.height&&(c=this.height-1)):(c<0&&(c=0),c+=this.margins.top,c>this.margins.bottom&&(c=this.margins.bottom)),this.cursor.x=b,this.cursor.y=c,this.postCursor()},ev_report:function(a){switch(a){case"status":case"printer":case"cursorPosition":case"deviceAttributes":case"versionString":break;default:throw"Can't handle report type "+a}},ev_charset:function(a,b,c){if(a=="switch")this.charsets.active=b;else if(a=="set")this.charsets[b]=c;else throw"Can't handle charset action "+a},putChar:function(a,b,c,d,e,f,g,h,i,j){var k=b+c*this.width;if(a=="set")this.scr.c.text.splice(k,1,d),this.scr.c.bold.splice(k,1,e),this.scr.c.underline.splice(k,1,f),this.scr.c.lowintensity.splice(k,1,g),this.scr.c.blink.splice(k,1,h),this.scr.c.fcolor.splice(k,1,i),this.scr.c.bcolor.splice(k,1,j);else throw"Can't putChar with method "+a},scroll:function(b){var c,d;if(b>0)c=this.margins.top,d=this.margins.bottom;else if(b<0)c=this.margins.bottom,d=this.margins.top;else return;var e=this.width*c,f=this.width*d;for(var g=0;g<Math.abs(b);g++){var h={};h.text=this.scr.c.text.splice(e,this.width).join(""),h.bold=this.scr.c.bold.splice(e,this.width).map(a).join(""),h.underline=this.scr.c.underline.splice(e,this.width).map(a).join(""),h.lowintensity=this.scr.c.lowintensity.splice(e,this.width).map(a).join(""),h.blink=this.scr.c.blink.splice(e,this.width).map(a).join(""),h.fcolor=this.scr.c.fcolor.splice(e,this.width).join(""),h.bcolor=this.scr.c.bcolor.splice(e,this.width).join(""),h.lineAttr=this.scr.lineAttr.splice(c,1),this.postSpecial({scrollLine:h,direction:b/Math.abs(b)});for(var i=0;i<this.width;i++)this.scr.c.text.splice(f,0," "),this.scr.c.bold.splice(f,0,!1),this.scr.c.underline.splice(f,0,!1),this.scr.c.lowintensity.splice(f,0,!0),this.scr.c.blink.splice(f,0,!1),this.scr.c.fcolor.splice(f,0,7),this.scr.c.bcolor.splice(f,0,0);this.scr.lineAttr.splice(d,0,{width:"normal",height:"normal"})}for(var j=this.margins.top;j<=this.margins.bottom;j++)this.postChange(j,0,this.width-1)},handleEventDirect:function(){this.handleEvent(Array.prototype.slice.call(arguments))},handleEvent:function(a){var b=this["ev_"+a[0]];b?b.apply(this,a.slice(1)):console.log("Warning: can't handle event type "+a[0])}};return f}();typeof exports!="undefined"&&(exports.VTEmulator=VTEmulator);var VTFont=function(){var a="?".charCodeAt(0),b={},c={},d="./fonts/",e=function(a){d=a},f=function(a,b){if(c[a])c[a].callbacks.push(b);else{var e=c[a]={image:new Image,loadedImage:!1,loadedChars:!1,charsXHR:new XMLHttpRequest,callbacks:[b]};e.image.onload=function(){e.loadedImage=!0,e.loadedChars&&g(a)},e.image.src=d+a+".png";var f=e.charsXHR;f.open("GET",d+a+".txt",!0),f.onreadystatechange=function(){f.readyState==4&&(f.status!=200?(e.callbacks.forEach(function(a){a(null,"Couldn't load stats file")}),delete c[a]):(e.loadedChars=!0,e.loadedImage&&g(a)))},f.send(null)}},g=function(a){var d=c[a];b[a]=new i(a,d.image,d.charsXHR.responseText),delete c[a],d.callbacks.forEach(function(c){c(b[a],null)})},h=function(a,c){b[a]?c(b[a],null):f(a,c)},i=function(a,c,d){b[a]=this,this.image=c;var e=this.chars={};this.colorMaps={};var f=0,g=0,h=0,i=0,j=0;d.split("\n").forEach(function(a){if(a.length){var b;if(/^\d+$/.exec(a))e[a]=[f++,g],j=parseInt(a,10),h++;else if(/^y$/.exec(a))f>i&&(i=f),f=0,g++;else{if(!(b=/^r(\d+)$/.exec(a)))throw'Stats file is corrupt, line="'+a+'"';var c=parseInt(b[1],10);for(var d=j+1;d<=j+c;d++)e[d]=[f++,g];h+=c,j+=c}}}),f>i&&(i=f),this.charCount=h,this.charHeight=this.image.naturalHeight/(g+1),this.charWidth=this.image.naturalWidth/i;if(this.charWidth!=Math.floor(this.charWidth))throw'font loading of "'+a+'" failed: image width is not a multiple of the character count (image width = '+this.image.naturalWidth+", character count = "+this.charCount+")"};i.prototype={drawChar:function(b,c,d,e,f,g){var h=c.charCodeAt(0),i;typeof this.chars[h]!="undefined"&&(i=this.chars[h]);if(typeof i=="undefined")if(typeof this.chars[a]!="undefined")i=this.chars[a];else throw"Can't draw \""+c+'", it is not mapped and neither is the missing character';b.drawImage(this.getFontColorMap(f,g,i[1]),i[0]*this.charWidth,0,this.charWidth,this.charHeight,d,e,this.charWidth,this.charHeight)},getFontColorMap:function(a,b,c){var d=a+"/"+b+"/"+c;if(this.colorMaps[d])return this.colorMaps[d];var e=this.image.naturalWidth,f=this.charHeight,g=c*this.charHeight,h=document.createElement("canvas");h.setAttribute("width",e),h.setAttribute("height",f);var i=h.getContext("2d");i.drawImage(this.image,0,g,e,f,0,0,e,f);var j=i.getImageData(0,0,e,f),k=i.createImageData(e,f),l=j.data,m=k.data;a=this.parseColor(a),b=this.parseColor(b);for(var n=0;n<f;n++)for(var o=0;o<e;o++){var p=(n*e+o)*4;l[p]>127?(m[p]=b[0],m[p+1]=b[1],m[p+2]=b[2],m[p+3]=255):(m[p]=a[0],m[p+1]=a[1],m[p+2]=a[2],m[p+3]=255)}i.putImageData(k,0,0),this.colorMaps[d]=h;return h},parseColor:function(a){var b;if(b=/^(\d+),(\d+),(\d+)$/.exec(a))return[parseInt(b[1],10),parseInt(b[2],10),parseInt(b[3],10)];throw"Can't parse color \""+a+'"'}};return{open:h,setBase:e,Font:i}}(),VTParser=function(){var a=function(a){console.log(a)};return function(b,c){c||(c=a),this.cb=b,this.warn=c,this.buffer=""}}();VTParser.prototype={parse:function(a){this.buffer+=a;while(this.handleBuffer());if(this.buffer.length>1024)throw"Appear to be stuck at: "+JSON.stringify(this.buffer.toString())},freeze:function(){return{buffer:this.buffer}},thaw:function(a){this.buffer=a.buffer},handleBuffer:function(){var a,b,c,d=this;this.handlables.forEach(function(e){var f=e[0].exec(d.buffer);f&&f[0].length>0&&(!b||f[0].length<b[0].length)&&(b=f,a=e[1],c=e[0])});if(!b)return!1;var e=b[0].length;a.call(this,b),this.buffer=this.buffer.substr(e);return!0},handlables:[[/^\007/,function(a){this.cb("specialChar","bell")}],[/^\010/,function(a){this.cb("specialChar","backspace")}],[/^\011/,function(a){this.cb("specialChar","horizontalTab")}],[/^\012/,function(a){this.cb("specialChar","lineFeed")}],[/^\013/,function(a){this.cb("specialChar","verticalTab")}],[/^\014/,function(a){this.cb("specialChar","formFeed")}],[/^\015/,function(a){this.cb("specialChar","carriageReturn")}],[/^\016/,function(a){this.cb("charset","switch","g1")}],[/^\017/,function(a){this.cb("charset","switch","g0")}],[/^[^\033\007\010\011\012\013\014\015\016\017\x80-\xFF]+/,function(a){/[\x80-\xFF]/.exec(a)&&console.log("low byte regex matched high bytes"),this.cb("normalString",a[0])}],[/^[\xC2\xDF][\x80-\xBF]/,function(a){var b=a[0].charCodeAt(0)-192,c=a[0].charCodeAt(1)-128,d=b*64+c;this.cb("normalString",String.fromCharCode(d))}],[/^(\xE0[\xA0-\xBF]|[\xE1-\xEC][\x80-\xBF]|\xED[\x80-\x9F]|[\xEE-\xEF][\x80-\xBF])[\x80-\xBF]/,function(a){var b=a[0].charCodeAt(0)-224,c=a[0].charCodeAt(1)-128,d=a[0].charCodeAt(2)-128,e=(b*64+c)*64+d;this.cb("normalString",String.fromCharCode(e))}],[/^(\xF0[\x90-\xBF]|[\xF1-\xF3][\x80-\xBF]|\xF4[\x80-\x8F])[\x80-\xBF][\x80-\xBF]/,function(a){var b=a[0].charCodeAt(0)-240,c=a[0].charCodeAt(1)-128,d=a[0].charCodeAt(2)-128,e=a[0].charCodeAt(3)-128,f=((b*64+c)*64+d)*64+e;this.cb("normalString",String.fromCharCode(f))}],[/^\033\[([0-9]*)A/,function(a){this.cb("arrow","up",parseInt(a[1]||"1",10))}],[/^\033\[([0-9]*)B/,function(a){this.cb("arrow","down",parseInt(a[1]||"1",10))}],[/^\033\[([0-9]*)C/,function(a){this.cb("arrow","right",parseInt(a[1]||"1",10))}],[/^\033\[([0-9]*)D/,function(a){this.cb("arrow","left",parseInt(a[1]||"1",10))}],[/^\033\[([0-9]*);([0-9]*)[Hf]/,function(a){this.cb("goto",[parseInt(a[2]||"1",10),parseInt(a[1]||"1",10)])}],[/^\033\[[Hf]/,function(a){this.cb("goto","home")}],[/^\033D/,function(a){this.cb("index","down")}],[/^\033M/,function(a){this.cb("index","up")}],[/^\033E/,function(a){this.cb("index","nextLine")}],[/^\033[7]/,function(a){this.cb("cursorStack","push")}],[/^\033[8]/,function(a){this.cb("cursorStack","pop")}],[/^\033=/,function(a){this.cb("mode","keypad","cursor")}],[/^\033>/,function(a){this.cb("mode","keypad","numeric")}],[/^\033\(A/,function(a){this.cb("charset","set","g0","uk")}],[/^\033\(B/,function(a){this.cb("charset","set","g0","us")}],[/^\033\(0/,function(a){this.cb("charset","set","g0","line")}],[/^\033\(1/,function(a){this.cb("charset","set","g0","rom")}],[/^\033\(2/,function(a){this.cb("charset","set","g0","romSpecial")}],[/^\033\)A/,function(a){this.cb("charset","set","g1","uk")}],[/^\033\)B/,function(a){this.cb("charset","set","g1","us")}],[/^\033\)0/,function(a){this.cb("charset","set","g1","line")}],[/^\033\)1/,function(a){this.cb("charset","set","g1","rom")}],[/^\033\)2/,function(a){this.cb("charset","set","g1","romSpecial")}],[/^\033N(a|[^a])/,function(a){this.cb("g2char",a[1])}],[/^\033O(a|[^a])/,function(a){this.cb("g3char",a[1])}],[/^\033\[(\??)([^\033]*?)h/,function(a){var b=this;a[2].split(";").forEach(function(c){b.setMode(a[1]+c)})}],[/^\033\[(\??)([^\033]*?)l/,function(a){var b=this;a[2].split(";").forEach(function(c){b.resetMode(a[1]+c)})}],[/^\033H/,function(a){this.cb("tabStop","add")}],[/^\033\[0?g/,function(a){this.cb("tabStop","remove")}],[/^\033\[3g/,function(a){this.cb("tabStop","clear")}],[/^\033#3/,function(a){this.cb("lineAttr","dwdhTopHalf")}],[/^\033#4/,function(a){this.cb("lineAttr","dwdhBottomHalf")}],[/^\033#5/,function(a){this.cb("lineAttr","swsh")}],[/^\033#6/,function(a){this.cb("lineAttr","dwsh")}],[/^\033\[0?K/,function(a){this.cb("eraseInLine","toEnd")}],[/^\033\[1K/,function(a){this.cb("eraseInLine","toStart")}],[/^\033\[2K/,function(a){this.cb("eraseInLine","whole")}],[/^\033\[0?J/,function(a){this.cb("eraseInDisplay","toEnd")}],[/^\033\[1J/,function(a){this.cb("eraseInDisplay","toStart")}],[/^\033\[2J/,function(a){this.cb("eraseInDisplay","whole")}],[/^\033\[([0-9]*)P/,function(a){this.cb("deleteChars",parseInt(a[1].length?a[1]:"1",10))}],[/^\033\[([0-9]*)L/,function(a){this.cb("insertLines",parseInt(a[1].length?a[1]:"1",10))}],[/^\033\[([0-9]*)M/,function(a){this.cb("deleteLines",parseInt(a[1].length?a[1]:"1",10))}],[/^\033([0-9;?]*)n/,function(a){var b=this;a[1].split(";").forEach(function(a){b.handleReportRequest(a)})}],[/^\033(\[0?c|Z)/,function(a){this.cb("report","deviceAttributes")}],[/^\033\[>c/,function(a){this.cb("report","versionString")}],[/^\033\[([0-9;]*)q/,function(a){var b=this;(a[1].length?a[1]:"0").split(";").forEach(function(a){b.handleLED(a)})}],[/^\033\]2;([^\033\007]*)\007/,function(a){this.cb("setWindowTitle",a[1])}],[/^\033\]1;([^\033\007]*)\007/,function(a){this.cb("setIconTitle",a[1])}],[/^\033\]0;([^\033\007]*)\007/,function(a){this.cb("setWindowIconTitle",a[1])}],[/^\033\[([0-9]+);([0-9]+)r/,function(a){this.cb("setMargins",parseInt(a[1],10),parseInt(a[2],10))}],[/^\033\[r/,function(a){this.cb("resetMargins")}],[/^\033\[!p/,function(a){this.cb("softReset")}],[/^\033c/,function(a){this.cb("reset")}],[/^\033\[([0-9;]*)m/,function(a){var b=this;(a[1].length?a[1]:"0").split(";").forEach(function(a){b.cb("setAttribute",parseInt(a,10))})}],[/^\033\[([0-9;]*)y/,function(a){this.cb("hardware","selfTestRaw",a[1])}],[/^\033#8/,function(a){this.cb("hardware","screenAlignment")}]],setMode:function(a){switch(a){case"?1":this.cb("mode","cursorKeyANSI",!1);break;case"?3":this.cb("mode","width",132);break;case"?4":this.cb("mode","scroll","smooth");break;case"?5":this.cb("mode","reverseScreen",!0);break;case"?6":this.cb("originMode","margin");break;case"?7":this.cb("mode","autoWrap",!0);break;case"?8":this.cb("mode","autoRepeat",!0);break;case"?9":this.cb("mode","mouseTrackingDown",!0);break;case"?47":this.cb("mode","currentScreen",0);break;case"?1000":this.cb("mode","mouseTrackingUp",!0);break;case"2":this.cb("mode","keyboardLocked",!0);break;case"4":this.cb("mode","insert",!0);break;case"12":this.cb("mode","localEcho",!1);break;case"20":this.cb("mode","newLineMode","crlf");break;default:this.warn('Unhandled set mode: "'+a+'"')}},resetMode:function(a){switch(a){case"?1":this.cb("mode","cursorKeyANSI",!0);break;case"?2":this.cb("mode","vt52",!0);break;case"?3":this.cb("mode","width",80);break;case"?4":this.cb("mode","scroll","jump");break;case"?5":this.cb("mode","reverseScreen",!1);break;case"?6":this.cb("originMode","screen");break;case"?7":this.cb("mode","autoWrap",!1);break;case"?8":this.cb("mode","autoRepeat",!1);break;case"?9":this.cb("mode","mouseTrackingDown",!1);break;case"?47":this.cb("mode","currentScreen",1);break;case"?1000":this.cb("mode","mouseTrackingUp",!1);break;case"2":this.cb("mode","keyboardLocked",!1);break;case"4":this.cb("mode","insert",!1);break;case"12":this.cb("mode","localEcho",!0);break;case"20":this.cb("mode","newLineMode","cr");break;default:this.warn('Unhandled reset mode: "'+a+'"')}},handleReportRequest:function(a){switch(a){case"5":this.cb
("report","status");break;case"?15":this.cb("report","printer");break;case"6":this.cb("report","cursorPosition");break;default:this.warn('Unhandled report request: "'+a+'"')}},handleLED:function(a){a=parseInt(a,10),a==0?this.cb("led","off","all"):this.cb("led","on",a)}},typeof exports!="undefined"&&(exports.VTParser=VTParser),TTYRecParse=function(a){var b=[],c=0;while(c<a.length){var d=r_uint32le(a,c);c+=4;var e=r_uint32le(a,c);c+=4;var f=r_uint32le(a,c);c+=4;var g=a.substr(c,f);c+=f;for(var h=0;h<f;h++)if(g.charCodeAt(h)>255){g=fixHighCharCodes(g);break}b.push({time:d+e/1e6,data:g})}return b}